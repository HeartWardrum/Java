# 2023年8月17日

## MyBatis

这是一个持久化层的框架，这是一个ORM的框架

持久化：泛指所有针对数据库的操作

ORM：Object-Relational Mapping 对象关系映射，数据库中的一张表和Java中的一个实体类对应，表中的一个字段和Java中的一个成语变量对应，表中的一行记录和Java中的一个对象对应

### 搭建MyBatis框架的步骤

1、创建Maven项目，导入MyBatis和数据库的依赖
2、在pom.xml中指明配置文件的路径
3、添加实体类对应数据库中的表
4、添加MyBatis总的配置文件
5、添加SQL语句的配置文件
6、在总的配置文件中加载SQL语句的配置文件
7、添加测试类，配置二级缓存和一级缓存，完成测试

pom.xml:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.iweb</groupId>
    <artifactId>MyBatis20230817</artifactId>
    <version>1.0-SNAPSHOT</version>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>


    <dependencies>

        <!--    MyBatis    -->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.5.6</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.23</version>
        </dependency>


    </dependencies>


    <build>
        <resources>
            <resource>
                <directory>src/main/java</directory>
                <includes>
                    <include>**/*.xml</include>
                </includes>
            </resource>
            <resource>
                <directory>src/main/resources</directory>
                <includes>
                    <include>**/*.xml</include>
                </includes>
            </resource>
        </resources>
    </build>
</project>
```

src/main/resources/mybatis-config.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration


        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="mysql">
        <environment id="mysql">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://192.168.77.100:3306/mysql?characterEncoding=utf-8"/>
                <property name="username" value="root"/>
                <property name="password" value="123456"/>
            </dataSource>
        </environment>


    </environments>


    <mappers>
        <mapper resource="com/iweb/dao/MyBook.xml"/>
    </mappers>
</configuration>
```

项目的dao包中的配置文件 MyBook.xml:

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybook">
    <select id="queryById" parameterType="int" resultType="com.iweb.model.MyBook">
        select * from mybook  where id = #{id}
    </select>
</mapper>
```

测试类：

```java
package com.iweb.test;

import com.iweb.model.MyBook;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.IOException;
import java.io.InputStream;

public class Test1 {

    public static void main(String[] args) {
        InputStream inputStream = null;
        SqlSession sqlSession = null;

        try {
            inputStream = Resources.getResourceAsStream("mybatis-config.xml");
            //由工厂的建造者拿着inputStream材料去建一座生产SqlSession的工厂 ，SqlSessionFactory成为MyBatis的二级缓存
            SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
            //工厂开始生产SqlSession对象 , sqlSession成为MyBatis的一级缓存
            sqlSession = sqlSessionFactory.openSession();
            //由SqlSession对象调用方法执行SQL语句
            int id = 1001;
            MyBook myBook = sqlSession.selectOne("mybook.queryById", id);
            sqlSession.commit();
            System.out.println(myBook);
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (sqlSession != null)
                sqlSession.close();

        }
    }
}
```

### MyBatis常用方法

selectOne() ---- 查询一条语句

selectList() ---- 查询多条记录

```java
List<MyBook> myBooks = sqlSession.selectList("mybook.queryAll");
```

```xml
<select id="queryAll"  resultType="com.iweb.model.MyBook">
    select * from mybook
</select>
```

insert() ---- 新增一条记录

```java
MyBook myBook = new MyBook(null, "The Little Prince", "Richard Howard");
int i = sqlSession.insert("mybook.addOne",myBook);
sqlSession.commit();
System.out.println(i);
```

```xml
<insert id="addOne" parameterType="com.iweb.model.MyBook">
    insert into mybook values(null,#{bookname},#{author})
</insert>
```

delete() ---- 删除一条记录

```java
int i = sqlSession.delete("mybook.deleteOne",id);
```

update() ---- 修改一条记录

```java
int id = 1113;
MyBook myBook = sqlSession.selectOne("mybook.queryById",id);
myBook.setBookname("琼恩兰尼斯特的费伦之旅");
myBook.setAuthor("博德之门");
int i = sqlSession.update("mybook.updateOne",myBook);
```

```xml
<update id="updateOne" parameterType="com.iweb.model.MyBook">
    update mybook set bookname = #{bookname} , author = #{author} where id = #{id}
</update>
```

**注意**：在MyBatis中，任何传参和返回值在没有ORM的时候，都可以使用Map来封装数据

查询全部：

```java
List<Map<String, Object>> myBooks = sqlSession.selectList("mybook.queryAll2");
sqlSession.commit();
System.out.println(myBooks);
```

```xml
<select id="queryAll2" resultType="java.util.HashMap">
    select * from mybook
</select>
```

新增一条：

```java
Map<String, Object> map = new HashMap<>();
map.put("id", null);
map.put("bookname", "1984");
map.put("author", "George Orwell");
int i = sqlSession.insert("mybook.addOne2", map);
System.out.println(i);
```

```xml
<insert id="addOne2" parameterType="java.util.HashMap">
    insert into mybook values(null,#{bookname},#{author})
</insert>
```

###  `<resultMap>`

创造一个ORM对象的映射

type表示实体类

`<result>`表示具体的对应关系

`<property>`表示成员变量

`<column>`表示字段

新的MyBook类：

```java
package com.iweb.model;

public class MyBook2 {
    private Integer my_id;
    private String  my_bookname;
    private String  my_author;
```

```xml
<resultMap id="myResult" type="com.iweb.model.MyBook2">
    <result property="my_id" column="id"></result>
    <result property="my_bookname" column="bookname"></result>
    <result property="my_author" column="author"></result>
</resultMap>

<select id="queryAll3" resultMap="myResult">
    select * from mybook
</select>
```

```java
List<MyBook2> myBook2s = sqlSession.selectList("mybook.queryAll3");
System.out.println(myBook2s);
```

### 动态SQL

在MyBatis中，我们使用<if>标签来动态拼接SQL语句

test属性表示判断条件，当条件满足就会拼上<if>标签对中的子语句

```xml
<select id="queryByParam" parameterType="java.util.Map" resultType="com.iweb.model.MyBook">
    select * from mybook
    where 1=1
    <if test="id!=null">
        and id = #{id}
    </if>
    <if test="bookname!=null">
        and bookname = #{bookname}
    </if>
    <if test="author!=null">
        and author = #{author}
    </if>
</select>
```

```java
Map<String,Object> map = new HashMap<>();
map.put("bookname","1984");
List<MyBook> myBooks = sqlSession.selectList("mybook.queryByParam",map);
System.out.println(myBooks);
```

### 面向接口编程

1、接口名、配置文件名、命名空间名一致
2、接口中方法名和配置文件中SQL语句的id一致
3、接口中方法的参数和SQL语句的参数类型一致
4、接口中方法的返回值类型和SQL语句的返回值类型一致
满足以上四点，当我们调用接口中的方法，会自动执行SQL语句完成数据库操作。

model文件夹下User类：

```java
package com.iweb.model;

public class User {
    private String id;
    private String username;
    private String password;


    public User() {
    }

    public User(String id, String username, String password) {
        this.id = id;
        this.username = username;
        this.password = password;
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    @Override
    public String toString() {
        return "User{" +
                "id='" + id + '\'' +
                ", username='" + username + '\'' +
                ", password='" + password + '\'' +
                '}';
    }
}
```

dao文件夹下UserDao接口：

```java
package com.iweb.dao;

import com.iweb.model.User;

import java.util.List;

public interface UserDao {

    public void addOne(User user);

    public List<User> queryAll();

    public User queryById(String id);

    public void updateOne(User user);

    public void deleteOne(String id);

}
```

dao文件夹下，UserDao.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iweb.dao.UserDao">
    <insert id="addOne" parameterType="com.iweb.model.User">
        insert into my_user values(#{id},#{username},#{password})
    </insert>

    <select id="queryAll" resultType="com.iweb.model.User">
        select * from my_user
    </select>

    <select id="queryById" parameterType="java.lang.String" resultType="com.iweb.model.User">
        select * from my_user where id = #{id}
    </select>

    <update id="updateOne" parameterType="com.iweb.model.User" >
        update my_user set username = #{username} , password = #{password} where id = #{id}
    </update>

    <delete id="deleteOne" parameterType="java.lang.String" >
        delete from my_user where id = #{id}
    </delete>
</mapper>
```

修改mybatis-config.xml,在<mapper>标签中添加一行：

```xml
<mappers>
    <mapper resource="com/iweb/dao/MyBook.xml"/>
    <mapper resource="com/iweb/dao/UserDao.xml"/>   <!-- 添加了这一行 -->
</mappers>
```

测试类：

```java
package com.iweb.test;

import com.iweb.dao.UserDao;
import com.iweb.model.MyBook;
import com.iweb.model.User;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class Test2 {

    public static void main(String[] args) {
        InputStream inputStream = null;
        SqlSession sqlSession = null;

        try {
            inputStream = Resources.getResourceAsStream("mybatis-config.xml");
            //由工厂的建造者拿着inputStream材料去建一座生产SqlSession的工厂 ，SqlSessionFactory成为MyBatis的二级缓存
            SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
            //工厂开始生产SqlSession对象 , sqlSession成为MyBatis的一级缓存
            sqlSession = sqlSessionFactory.openSession();
            //由SqlSession对象调用方法执行SQL语句


            //主要修改的是这边
            UserDao ud = sqlSession.getMapper(UserDao.class);
            List<User> users = ud.queryAll();
            System.out.println(users);
            
            
            sqlSession.commit();
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (sqlSession != null)
                sqlSession.close();

        }
    }
}
```

查询一条：

```java
UserDao ud = sqlSession.getMapper(UserDao.class);
User user = ud.queryById("1005");
System.out.println(user);
```

新增一条：

```java
UserDao ud = sqlSession.getMapper(UserDao.class);
User user = new User("1007","lannister","7788");
ud.addOne(user);
```

修改一条：

```java
UserDao ud = sqlSession.getMapper(UserDao.class);
User user = ud.queryById("1007");
user.setUsername("join_lannister");
user.setPassword("3223");
ud.updateOne(user);
```

删除一条：

```java
UserDao ud = sqlSession.getMapper(UserDao.class);
ud.deleteOne("1007");
```

### 一对一级联查询

1、首先确定主从表，查询主表带出从表
2、编写各自实体类和接口，主表的实体类中包含从表类型的成员变量 
3、在主表查询语句中编写`<resultMap>`创建ORM对象关系映射，其中关联条件的`<result>`中的property对应成员变量，column对应关联字段，select对应从表的关联查询语句的id，javatype对应从表关联查询的返回值类型

Card实体类：

```java
package com.iweb.model;

public class Card {
    private String cardid;
    private String address;
    private String pname;
    private String starttime;

    public Card() {
    }

    public Card(String cardid, String address, String pname, String starttime) {
        this.cardid = cardid;
        this.address = address;
        this.pname = pname;
        this.starttime = starttime;
    }

    public String getCardid() {
        return cardid;
    }

    public void setCardid(String cardid) {
        this.cardid = cardid;
    }

    public String getAddress() {
        return address;
    }

    public void setAddress(String address) {
        this.address = address;
    }

    public String getPname() {
        return pname;
    }

    public void setPname(String pname) {
        this.pname = pname;
    }

    public String getStarttime() {
        return starttime;
    }

    public void setStarttime(String starttime) {
        this.starttime = starttime;
    }

    @Override
    public String toString() {
        return "Card{" +
                "cardid='" + cardid + '\'' +
                ", address='" + address + '\'' +
                ", pname='" + pname + '\'' +
                ", starttime='" + starttime + '\'' +
                '}';
    }
}
```

Person实体类：	

```java
package com.iweb.model;

public class Person {
    private String pid;
    private String pname;
    private Integer age;
    private String gender;
    private Card card;


    public Person() {
    }

    public Person(String pid, String pname, Integer age, String gender, Card card) {
        this.pid = pid;
        this.pname = pname;
        this.age = age;
        this.gender = gender;
        this.card = card;
    }

    public String getPid() {
        return pid;
    }

    public void setPid(String pid) {
        this.pid = pid;
    }

    public String getPname() {
        return pname;
    }

    public void setPname(String pname) {
        this.pname = pname;
    }

    public Integer getAge() {
        return age;
    }

    public void setAge(Integer age) {
        this.age = age;
    }

    public String getGender() {
        return gender;
    }

    public void setGender(String gender) {
        this.gender = gender;
    }

    public Card getCard() {
        return card;
    }

    public void setCard(Card card) {
        this.card = card;
    }

    @Override
    public String toString() {
        return "Person{" +
                "pid='" + pid + '\'' +
                ", pname='" + pname + '\'' +
                ", age=" + age +
                ", gender='" + gender + '\'' +
                ", card=" + card +
                '}';
    }

```

CardDao:

```java
package com.iweb.dao;

import com.iweb.model.Card;

public interface CardDao {

    //根据cardid查询一张身份证信息
    public Card queryById(String cardid);


}
```

CardDao.xml:

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iweb.dao.CardDao">

    <select id="queryById" parameterType="java.lang.String" resultType="com.iweb.model.Card">
        select c.cardid, c.pname, c.address, date_format(c.starttime, '%Y-%m-%d') starttime
        from card c
        where c.cardid = #{cardid}
    </select>
</mapper>
```

PersonDao:

```java
package com.iweb.dao;

import com.iweb.model.Person;

public interface PersonDao {

    //根据pid查询一个人的信息,以及他的身份证信息
    public Person queryById(String pid);

}
```

PersonDao.xml:

```java
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iweb.dao.PersonDao">

    <!--  根据pid查询一个人的信息,以及他的身份证信息  -->
    <select id="queryById" parameterType="java.lang.String" resultMap="personResult">
        select *
        from person p
        where p.pid = #{pid}
    </select>

    <resultMap id="personResult" type="com.iweb.model.Person">
        <result property="pid" column="pid"></result>
        <result property="pname" column="pname"></result>
        <result property="age" column="age"></result>
        <result property="gender" column="gender"></result>
        <association property="card" column="cardid"
                     select="com.iweb.dao.CardDao.queryById"
                     javaType="com.iweb.model.Card"></association>
    </resultMap>
</mapper>
```

mybatis-config.xml中加两行：

```xml
<mappers>
    <mapper resource="com/iweb/dao/MyBook.xml"/>
    <mapper resource="com/iweb/dao/UserDao.xml"/>
    <mapper resource="com/iweb/dao/CardDao.xml"/>
    <mapper resource="com/iweb/dao/PersonDao.xml"/>
</mappers>
```

测试类：

```java
PersonDao pd = sqlSession.getMapper(PersonDao.class);
Person person = pd.queryById("p001");
System.out.println(person);
```