# 2023年7月28日

## JDBC

这是Java连接数据库的标准接口

操作步骤

1. 加载数据库驱动
2. 获取数据库连接
3. 获取Statement对象
4. 执行sql语句
5. 处理查询结果
6. 关闭连接和资源

~~~java
//连接Oracle数据库中dept表
//数据库ip：192.168.77.100  端口： 1521  数据库服务名：helowin
//账号：scott  密码：123456 
public class JdbcExample {
    public static void main(String[] args) {
        String url = "jdbc:oracle:thin:@192.168.77.100:1521:helowin";
        String username = "scott";
        String password = "123456";

        Connection conn = null;//表示数据库的连接
        Statement stat = null;//表示操作SQL语句的对象
        ResultSet rest = null;//表示接收结果集的对象


        try {
            //加载数据库驱动，把Oracle驱动类手动加进内存
            Class.forName("oracle.jdbc.driver.OracleDriver");
            //获取数据库连接
            conn = DriverManager.getConnection(url, username, password);
            //获取Statement对象
            stat = conn.createStatement();
            //执行SQL语句并返回结果
            String sql = "select * from dept";
            rest = stat.executeQuery(sql);
            //循环遍历结果集并使用数据
            while (rest.next()) {
                int deptno = rest.getInt("deptno");
                String dname = rest.getString("dname");
                String loc = rest.getString("loc");
                System.out.println(deptno + ":" + dname + ":" + loc);
            }


        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {
                //关闭连接和资源
                if (rest != null)
                    rest.close();
                if (stat != null)
                    stat.close();
                if (conn != null)
                    conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}

~~~

打印结果：

~~~java
12:喝酒部:伊豆
70:人事部:伤害
10:ACCOUNTING:NEW YORK
20:RESEARCH:DALLAS
30:SALES:CHICAGO
40:OPERATIONS:BOSTON
50:轻音部:霓虹111
~~~



## ResultSetMetaData

(好处就是可以打印列名)

表示RestSet中列相关的信息，我们可以通过

RestSet.getMetaData() ---- 获取它的对象。

getColumnCount() ---- 得到列数

getColumnName(列数) ---- 得到某一列的字段名

~~~java
public class Test {

    public static void main(String[] args) {
        String url = "jdbc:oracle:thin:@192.168.77.100:1521:helowin";
        String username = "scott";
        String password = "123456";

        Connection conn = null;
        Statement stat = null;
        ResultSet rest = null;
        ResultSetMetaData rsmd = null;

        try {
            Class.forName("oracle.jdbc.driver.OracleDriver");

            conn = DriverManager.getConnection(url, username, password);

            stat = conn.createStatement();

            String sql = "select * from dept";
            rest = stat.executeQuery(sql);

            rsmd = rest.getMetaData();
            int columnCount = rsmd.getColumnCount();
            while (rest.next()) {
                for (int i = 1; i <= columnCount; i++) {
                    String columnName = rsmd.getColumnName(i);
                    Object columnValue = rest.getObject(i);
                    System.out.print(columnName + "=" + columnValue + "    ");

                }
                System.out.println();
            }

        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {
                if (rest != null)
                    rest.close();
                if (stat != null)
                    stat.close();
                if (conn != null)
                    conn.close();

            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}
~~~

打印结果

~~~java
DEPTNO=12    DNAME=喝酒部    LOC=伊豆    
DEPTNO=70    DNAME=人事部    LOC=伤害    
DEPTNO=10    DNAME=ACCOUNTING    LOC=NEW YORK    
DEPTNO=20    DNAME=RESEARCH    LOC=DALLAS    
DEPTNO=30    DNAME=SALES    LOC=CHICAGO    
DEPTNO=40    DNAME=OPERATIONS    LOC=BOSTON    
DEPTNO=50    DNAME=轻音部    LOC=霓虹111  
~~~

## executeUpdate(SQL语句)

由Statement对象调用该方法，执行增删改语句

~~~java
public class Test2 {
    public static void main(String[] args) {
        Connection conn = null;//表示数据库的连接
        Statement stat = null;//表示操作SQL语句的对象
        try {
            //加载数据库驱动，把Oracle驱动类手动加进内存
            Class.forName("oracle.jdbc.driver.OracleDriver");
            //获取数据库连接
            conn = DriverManager.getConnection(
                    "jdbc:oracle:thin:@192.168.77.100:1521:helowin",
                    "scott",
                    "123456");
            //获取Statement对象
            stat = conn.createStatement();
            //执行SQL语句并返回结果
            String sql = "insert into dept values('60','运维部','北京')";
            int i = stat.executeUpdate(sql);
            System.out.println("成功编辑了 " + i + " 条记录");
            
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {

                if (stat != null)
                    stat.close();
                if (conn != null)
                    conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}

~~~

## 断点调试

我们在程序入口处打断点，使用Debug方式运行，程序会在断点处停下来，我们可以单步调试，如果调用方法，那么可以使用setup into进入所调用的方法继续调试，我们还可以使用resume program一次性走到下一个断点，如果没有下一个断点，则直接走完。

在调试的过程中，我们可以选中公式或表达式，点击Evalute Expression进行取值的查看，

## CallableStatement

用来调用存储过程，我们通过Connection对象调用`prepareCall("{call 存储过程名(?,?,?,...)}")`来获取该对象，然后通过`该对象.setXxx(序号，值)`给存储过程赋参数值，最后调用`execute()`来执行存储过程

~~~java
public class Test4 {
    public static void main(String[] args) {
        Connection conn = null;//表示数据库的连接
        CallableStatement stat = null;//表示操作SQL语句的对象
        try {
            //加载数据库驱动，把Oracle驱动类手动加进内存
            Class.forName("oracle.jdbc.driver.OracleDriver");
            //获取数据库连接
            conn = DriverManager.getConnection(
                    "jdbc:oracle:thin:@192.168.77.100:1521:helowin",
                    "scott",
                    "123456");
            //获取Statement对象
            stat = conn.prepareCall("{call my_pro(?,?,?)}");
            stat.setInt(1, 70);
            stat.setString(2, "人事部");
            stat.setString(3, "伤害");
            stat.execute();
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {

                if (stat != null)
                    stat.close();
                if (conn != null)
                    conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}

~~~

## confirm("字符串")

弹出一个确认框，当用户点击确定时，返回true，当用户点击取消时，返回false

## JDBC方法封装

~~~java
public class JdbcUtil {
    private static final String URL = "jdbc:oracle:thin:@192.168.77.100:1521:helowin";
    private static final String USERNAME = "scott";
    private static final String PASSWORD = "123456";

    private static Connection conn = null;
    private static Statement stat = null;
    private static ResultSet rest = null;

    public JdbcUtil() {

    }

    //获取数据库连接
    public static Connection getConn() {
        try {
            Class.forName("oracle.jdbc.driver.OracleDriver");
            conn = DriverManager.getConnection(URL, USERNAME, PASSWORD);
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return conn;
    }

    //关闭所有资源和连接
    public static void closeSource() {
        try {
            if (rest != null)
                rest.close();
            if (stat != null)
                stat.close();
            if (conn != null)
                conn.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    /*
    统一进行查询的JDBC方法
     */
    public static List<Map<String, Object>> queryBySql(String sql) {
        List<Map<String, Object>> list = new ArrayList<>();

       
        ResultSetMetaData rsmd = null;
        try {
            stat = getConn().createStatement();
            rest = stat.executeQuery(sql);
            rsmd = rest.getMetaData();
            while (rest.next()) {
                Map<String, Object> map = new HashMap<>();
                for (int i = 1; i <= rsmd.getColumnCount(); i++) {
                    map.put(rsmd.getColumnName(i), rest.getObject(i));
                }
                list.add(map);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {
                if (rest != null)
                    rest.close();
                closeSource();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
        return list;
    }

    /*
    增删改
     */
    public static void editBySql(String sql) {
        try {
            stat = getConn().createStatement();
            int i = stat.executeUpdate(sql);
            System.out.println("成功编辑了" + i + "条记录");
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            closeSource();
        }
    }
}
~~~

~~~java
public class Test {

    public static void main(String[] args) {
       String sql = "delete from dept where deptno = 70";
       JdbcUtil.editBySql(sql);

//        String sql2 = "select * from dept";
//        System.out.println(JdbcUtil.queryBySql(sql2));
    }
}

~~~

## JDBC连接MySQL

只需要更改url、username、password、Class.forName()

~~~java
    private static final String URL =
            "jdbc:mysql://192.168.77.100:3306/mysql?characterEncoding=utf-8";
    private static final String USERNAME = "root";
    private static final String PASSWORD = "123456";
~~~

~~~java
            Class.forName("com.mysql.cj.jdbc.Driver");
~~~

## 模拟登录

~~~java
public class LoginService {
    public boolean login(String username, String password) {
        password = DigestUtils.md5Hex(password);
        String sql = "select count(*) cou from my_user where username = '" + username
                + "' and password = '" + password + "'";
        List<Map<String, Object>> list = JdbcUtil2.queryBySql(sql);
        Map<String, Object> map = list.get(0);
        Long rest = (Long) map.get("cou");
        return rest > 0;
    }
}
~~~

~~~java
public class Test {

    public static void main(String[] args) {

        String username = "root1";
        String password = "123456";
        LoginService loginService = new LoginService();
        if (loginService.login(username, password)) {
            System.out.println("登录成功！");
        } else {
            System.out.println("用户名或密码错误！");
        }

    }
}
~~~

## SQL注入

当参数值直接被拼到SQL语句中时，人为地传入部分SQL语句作为参数，可以绕过条件判断，达到查询的目的

~~~java
//使用SQL注入登录
public class Test {

    public static void main(String[] args) {

        String username = "1' or '1'='1' or '1'='1";//SQL注入
        String password = "123456";
        LoginService loginService = new LoginService();
        if (loginService.login(username, password)) {
            System.out.println("登录成功！");
        } else {
            System.out.println("用户名或密码错误！");
        }

    }
}
~~~

# 2023年7月31日

## PreparedStatement

和Statement对象类似，它也可以执行SQL语句

通过Connection调用prepareStatement(SQL语句)得到该对象

它采用参数绑定的方式来封装SQL语句，SQL语句中所有有参数的地方使用`?`

该对象调用setXxx(序号n，参数值)用来给第n个位置的`?`绑定参数值

他可以有效防止SQL注入

~~~java
//防止SQL注入，并且能传入多个参数的最终JDBC工具类
public class JdbcUtil2 {
    private static final String URL =
            "jdbc:mysql://192.168.77.100:3306/mysql?characterEncoding=utf-8";
    private static final String USERNAME = "root";
    private static final String PASSWORD = "123456";

    private static Connection conn = null;
    private static PreparedStatement pstat = null;
    private static ResultSet rest = null;

    public JdbcUtil2() {

    }

    //获取数据库连接
    public static Connection getConn() {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            conn = DriverManager.getConnection(URL, USERNAME, PASSWORD);
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return conn;
    }

    //关闭所有资源和连接
    public static void closeSource() {
        try {
            if (rest != null)
                rest.close();
            if (pstat != null)
                pstat.close();
            if (conn != null)
                conn.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    /*
    统一进行查询的JDBC方法
     */
    public static <T> List<Map<String, Object>> queryBySql(String sql, T... t) {
        List<Map<String, Object>> list = new ArrayList<>();

        ResultSetMetaData rsmd = null;
        try {
            pstat = getConn().prepareStatement(sql);
            for (int i = 0; i < t.length; i++) {
                pstat.setObject(i + 1, t[i]);
            }
            rest = pstat.executeQuery();
            rsmd = rest.getMetaData();
            while (rest.next()) {
                Map<String, Object> map = new HashMap<>();
                for (int i = 1; i <= rsmd.getColumnCount(); i++) {
                    map.put(rsmd.getColumnName(i), rest.getObject(i));
                }
                list.add(map);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            try {
                if (rest != null)
                    rest.close();
                closeSource();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
        return list;
    }

    /*
    增删改
     */
    public static <T> void editBySql(String sql, T... t) {
        int result = 0;
        try {
            pstat = getConn().prepareStatement(sql);
            for (int i = 0; i < t.length; i++) {
                pstat.setObject(i + 1, t[i]);
            }
            result = pstat.executeUpdate();
            System.out.println("成功编辑了" + result + "条记录");
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            closeSource();
        }
    }
}
~~~

~~~java
public class LoginService {
    public boolean login(String username, String password) {
        password = DigestUtils.md5Hex(password);
        String sql = "select count(*) cou from my_user where username = ? and password = ?";
        List<Map<String, Object>> list = JdbcUtil2.queryBySql(sql,username,password);
        Map<String, Object> map = list.get(0);
        long rest = (long) map.get("cou");
        System.out.println(rest);


        return rest > 0;
    }
}
~~~

~~~java
public class Test {

    public static void main(String[] args) {
//        String username = "root";
//        //String username = "1' or '1'='1' or '1'='1";//SQL注入
//        String password = "123456";
//        LoginService loginService = new LoginService();
//        if (loginService.login(username, password)) {
//            System.out.println("登录成功！");
//        } else {
//            System.out.println("用户名或密码错误！");
//        }

//
        String sql = "insert into mybook values(null,?,'')";
        JdbcUtil2.editBySql(sql,"海的房间","黄利群");


    }
}

~~~

